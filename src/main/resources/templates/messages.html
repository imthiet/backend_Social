<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Messages</title>


    <link rel="stylesheet" type="text/css" th:href="@{/css/head_cus.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/msglist.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}"/>



    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/js/sockjs.min.js"></script>
    <script src="/js/stomp.min.js"></script>

    <style>

    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

        <div class="container mt-4" id="message-container">

            <div th:each="userMessage : ${usersWithMessages}" class="user-message-card"
                 th:attr="data-username=${userMessage.user.username}" onclick="openChat(this.getAttribute('data-username'))">
                    <!-- Nội dung cho từng user message card -->
                        <div class="post-header">
                            <img th:src="@{/Image/home_bgr.jpg}" alt="User Image" class="profile-img">
                        </div>
                        <div class="message-content">
                            <h5 th:text="${userMessage.user.username}">Username</h5>
                            <p th:text="${userMessage.lastMessage.content}" style="font-weight:normal">Last message content...</p>
                        </div>
<!--                <input type="text" th:id="'new-comment-' + ${post.id}" placeholder="Show what you think..." required />-->
<!--                <div class="online-indicator" th:id="'online-'+${userMessage.user.username}" style="display: none;"></div>-->
                        <div class="last-message-time">
                            <span class="time-ago" th:attr="data-time=${userMessage.lastMessage.timestamp}"></span>
                    </div>

            </div>


        </div>
<script>
    // Kết nối WebSocket khi trang được load
    const socket = new SockJS('/websocket');
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, function () {
        console.log('WebSocket Connected');
    });
    const currentUserId = '[[${usn}]]';
    console.log("nguoi htai:"+currentUserId);

    // function checkUserStatus(username) {git
    //     fetch(`/api/status/${username}`)
    //         .then(response => response.json())
    //         .then(data => {
    //             console.log("Trạng thái người dùng đã được cập nhật:", data);
    //             updateChatListStatus(data.username, data.online);
    //         })
    //         .catch(error => console.error('Lỗi khi kiểm tra trạng thái người dùng:', error));
    // }
    //
    // function updateChatListStatus(username, isOnline) {
    //     const onlineIndicator = document.getElementById(`online-${username}`);
    //     if (onlineIndicator) {
    //         console.log("Cap nhat indicator");
    //         onlineIndicator.style.display = isOnline ? 'inline-block' : 'none';
    //     }
    //     else {
    //         console.log("Khong thay id indicator");
    //     }
    //
    // }
    //
    // // Kiểm tra trạng thái mỗi 5 giây
    // setInterval(() => {
    //     const username = '[[${usn}]]';  // Thay thế bằng tên người dùng thực tế
    //     checkUserStatus(username);
    // }, 2000);


    function sendMessage(event, userId) {
        if (event.key === "Enter") {
            const input = document.getElementById('message-input-${userId}');
            const messageContent = input.value.trim();

            if (messageContent) {
                // Gửi tin nhắn đến server thông qua WebSocket
                stompClient.send(`/app/chat/${userId}`, {}, JSON.stringify({
                    content: messageContent,
                    senderId: currentUserId/* ID của người dùng hiện tại */
                }));

                // Xóa input sau khi gửi
                input.value = '';
            }
        }
    }

    // Nhận tin nhắn từ server
    stompClient.subscribe('/user/queue/messages', function (message) {
        const messageData = JSON.parse(message.body);

        const chatMessages = document.getElementById('chat-messages-${messageData.senderId}');
        if (chatMessages) {
            // Thêm tin nhắn vào box chat tương ứng
            const messageElement = document.createElement('p');
            messageElement.textContent = messageData.content;
            chatMessages.appendChild(messageElement);
        }
    });
    function openChat(receiverUsername) {
        console.log("clicked: "+receiverUsername);
        if(receiverUsername != null)
        {
            console.log(receiverUsername);
        }
        else {
            console.log("Name is Null");
        }
        fetch('/api/chat/createChat/' + receiverUsername, {

            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to create or find chat');
                }
                return response.json(); // Chuyển kết quả thành JSON
            })
            .then(data => {
                const chatId = data; // Nếu API trả về chatId trực tiếp, dùng dòng này
                // const chatId = data.chatId; // Nếu API trả về dưới dạng { "chatId": 123 }, bỏ comment dòng này

                window.location.href = `/chat/${chatId}`;
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Unable to open chat.');
            });
    }


</script>
<script>
    // Function to calculate "time ago"
    function timeAgo(timestamp) {
        var currentTime = new Date();
        var notiTime = new Date(timestamp);
        var diff = currentTime - notiTime;

        var seconds = Math.floor(diff / 1000);
        var minutes = Math.floor(seconds / 60);
        var hours = Math.floor(minutes / 60);
        var days = Math.floor(hours / 24);

        if (days > 1) {
            return days + " days";
        } else if (days === 1) {
            return "1 day ";
        } else if (hours > 1) {
            return hours + " h";
        } else if (hours === 1) {
            return "1 hour";
        } else if (minutes > 1) {
            return minutes + " m";
        } else if (minutes === 1) {
            return "1 minute";
        } else {
            return "just now";
        }
    }

    // Function to update time-ago for each element
    function updateTimes() {
        const timeElements = document.querySelectorAll('.time-ago');
        timeElements.forEach(function (element) {
            var timestamp = element.getAttribute('data-time');
            element.textContent = timeAgo(timestamp);
        });
    }

    // Run the updateTimes function when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function () {
        updateTimes();
    });





</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>